<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NyarCode XLF Editor</title>
    <link rel="stylesheet" href="{{cssUri}}" />
    {{trumbowygCss}}
    <style>
      .trumbowyg-button-pane {
        background: #282828;
      }
      .light-theme .trumbowyg-button-pane {
        background: var(--header-bg);
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <img src="{{logoUri}}" alt="Nyarcode" class="logo" />
      <input
        class="filter"
        type="text"
        placeholder="Filter..."
        oninput="filterRows()"
      />
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="theme-icon">‚òÄÔ∏è</span>
      </button>
      <button class="save-btn" onclick="saveTranslations()">
        <span id="unsaved-indicator" class="unsaved-dot" style="display: none"
          >‚óè</span
        >
        Save
      </button>
    </div>
    <div class="table-container">
      <table id="xlfTable">
        <colgroup>
          <col id="col-number" style="width: 60px; min-width: 50px" />
          <col id="col-original" style="width: 42%; min-width: 25%" />
          <col
            id="col-copy"
            style="width: 50px; min-width: 50px; max-width: 50px"
          />
          <col id="col-translation" style="width: 42%; min-width: 25%" />
        </colgroup>
        <thead>
          <tr>
            <th id="th-number">#</th>
            <th id="th-original">
              Original ({{sourceLanguage}})
              <div class="resizer" data-col="col-original"></div>
            </th>
            <th id="th-copy">
              <div class="resizer" data-col="col-copy"></div>
            </th>
            <th id="th-translation">Translation ({{targetLanguage}})</th>
          </tr>
        </thead>
        <tbody>
          {{rows}}
        </tbody>
      </table>
    </div>
    <script src="{{jqueryJsUri}}"></script>
    <script src="{{trumbowygJsUri}}"></script>
    <script>
      const vscode = acquireVsCodeApi();

      vscode.setState({ fileUri: "{{fileUri}}" });

      function forceButtonColumnWidth(skipMainColumns = false) {
        const copyWidth = 50;

        const copyCol = document.getElementById("col-copy");

        if (copyCol) {
          copyCol.style.width = copyWidth + "px";
          copyCol.style.minWidth = copyWidth + "px";
          copyCol.style.maxWidth = copyWidth + "px";
        }

        const thCopy = document.getElementById("th-copy");
        if (thCopy) {
          thCopy.style.width = copyWidth + "px";
          thCopy.style.minWidth = copyWidth + "px";
          thCopy.style.maxWidth = copyWidth + "px";
        }

        document.querySelectorAll(".copy-cell").forEach((cell) => {
          cell.style.width = copyWidth + "px";
          cell.style.minWidth = copyWidth + "px";
          cell.style.maxWidth = copyWidth + "px";
        });

        if (!skipMainColumns) {
          const table = document.getElementById("xlfTable");
          if (!table) return;

          const tableWidth = table.offsetWidth;
          const numberWidth = 60;
          const availableWidth = tableWidth - numberWidth - copyWidth;
          const halfAvailable = Math.floor(availableWidth / 2);

          const colNumber = document.getElementById("col-number");
          const colOriginal = document.getElementById("col-original");
          const colTranslation = document.getElementById("col-translation");

          if (colNumber) {
            colNumber.style.width = numberWidth + "px";
          }

          if (colOriginal) {
            colOriginal.style.width = halfAvailable + "px";
          }

          if (colTranslation) {
            colTranslation.style.width = halfAvailable + "px";
          }
        }
      }

      forceButtonColumnWidth();

      setTimeout(forceButtonColumnWidth, 10);

      function toggleTheme() {
        document.body.classList.toggle("light-theme");
        const icon = document.getElementById("theme-icon");
        icon.textContent = document.body.classList.contains("light-theme")
          ? "üåô"
          : "‚òÄÔ∏è";
      }

      function unescapeHtml(text) {
        const textarea = document.createElement("textarea");
        textarea.innerHTML = text;
        return textarea.value;
      }

      let hasUnsavedChanges = false;
      const originalValues = new Map();

      function updateUnsavedIndicator() {
        const indicator = document.getElementById("unsaved-indicator");
        indicator.style.display = hasUnsavedChanges ? "inline" : "none";

        vscode.postMessage({
          command: "updateDirtyState",
          isDirty: hasUnsavedChanges,
        });
      }

      window.addEventListener("load", () => {
        forceButtonColumnWidth();

        const rows = document.querySelectorAll("#xlfTable tbody tr");
        rows.forEach((row, idx) => {
          const sourceTextarea = row.cells[1].querySelector("textarea");
          if (sourceTextarea) {
            sourceTextarea.value = unescapeHtml(sourceTextarea.value);
            sourceTextarea.addEventListener("keydown", (e) => {
              if (!e.ctrlKey && !e.metaKey) {
                e.preventDefault();
              } else if (
                e.key !== "c" &&
                e.key !== "C" &&
                e.key !== "a" &&
                e.key !== "A"
              ) {
                e.preventDefault();
              }
            });
            sourceTextarea.addEventListener("paste", (e) => e.preventDefault());
            sourceTextarea.addEventListener("cut", (e) => e.preventDefault());
            sourceTextarea.addEventListener("drop", (e) => e.preventDefault());
            sourceTextarea.addEventListener("input", (e) => e.preventDefault());
          }

          const targetTextarea = row.cells[2].querySelector("textarea");
          if (targetTextarea) {
            targetTextarea.value = unescapeHtml(targetTextarea.value);
            originalValues.set(idx, targetTextarea.value);
          }
        });
        setTimeout(() => {
          document
            .querySelectorAll("textarea.trumbowyg-editor")
            .forEach((textarea) => {
              const $ed = $(textarea)
                .siblings(".trumbowyg-box")
                .find(".trumbowyg-editor");
              if ($ed.length) {
                $ed[0].addEventListener("copy", (e) => {
                  e.preventDefault();
                  const tr = textarea.closest("tr");
                  if (!tr) return;
                  const cell = tr.cells[3];
                  let text = "";
                  let html = "";
                  if (window.getSelection && window.getSelection().toString()) {
                    text = window.getSelection().toString();
                    html = text;
                  } else {
                    const textarea = cell.querySelector(
                      "textarea.trumbowyg-editor"
                    );
                    if (textarea) {
                      html = $(textarea).trumbowyg("html");
                      const temp = document.createElement("div");
                      temp.innerHTML = html;
                      text = temp.innerText;
                    }
                  }
                  e.clipboardData.setData("text/plain", text);
                });
              }
            });
          if (window.$ && window.$.fn && window.$.fn.trumbowyg) {
            document
              .querySelectorAll("textarea.trumbowyg-editor")
              .forEach((textarea) => {
                if (!$(textarea).parent().hasClass("trumbowyg-box")) {
                  $(textarea).trumbowyg({
                    removeformatPasted: false,
                    autogrow: true,
                    tagsToRemove: [],
                    tagsToKeep: [
                      "div",
                      "span",
                      "section",
                      "article",
                      "header",
                      "footer",
                      "nav",
                      "aside",
                      "main",
                    ],
                    semantic: false,
                    btns: [
                      [
                        "bold",
                        "italic",
                        "underline",
                        "strikethrough",
                        "superscript",
                        "subscript",
                        "link",
                        "removeformat",
                        "viewHTML",
                        "fullscreen",
                      ],
                    ],
                  });
                  $(textarea).on("tbwchange", () => {
                    hasUnsavedChanges = true;
                    updateUnsavedIndicator();
                  });
                }
              });

            document
              .querySelectorAll("textarea.trumbowyg-editor-readonly")
              .forEach((textarea) => {
                if (!$(textarea).parent().hasClass("trumbowyg-box")) {
                  $(textarea).trumbowyg({
                    btns: [["viewHTML"]],
                    removeformatPasted: true,
                    disabled: true,
                  });
                  $(textarea).on("tbwchange tbwinit", function () {
                    const $editor = $(textarea)
                      .siblings(".trumbowyg-box")
                      .find(".trumbowyg-editor");
                    $editor.attr("contenteditable", "false");
                    $editor.css("cursor", "default");
                  });
                  $(textarea)
                    .siblings(".trumbowyg-box")
                    .find(".trumbowyg-editor")
                    .on("keydown paste cut drop input", function (e) {
                      if (!e.ctrlKey && !e.metaKey) {
                        if (
                          e.type !== "keydown" ||
                          (e.key !== "c" &&
                            e.key !== "C" &&
                            e.key !== "a" &&
                            e.key !== "A")
                        ) {
                          e.preventDefault();
                        }
                      } else if (e.type !== "keydown") {
                        e.preventDefault();
                      }
                    });
                  $(textarea)
                    .siblings(".trumbowyg-box")
                    .find(".trumbowyg-editor")
                    .on("dragstart dragover", function (e) {
                      e.preventDefault();
                    });
                }
              });
          }
          document
            .querySelectorAll(
              "textarea:not(.trumbowyg-editor):not(.trumbowyg-editor-readonly):not(.readonly-textarea)"
            )
            .forEach((textarea) => {
              textarea.addEventListener("input", () => {
                hasUnsavedChanges = true;
                updateUnsavedIndicator();
              });
            });
        }, 0);
      });

      function filterRows() {
        const filter = document.querySelector(".filter").value.toLowerCase();
        const rows = document.querySelectorAll("#xlfTable tbody tr");
        rows.forEach((row) => {
          const original = row.cells[1].innerText.toLowerCase();
          const textarea = row.cells[3].querySelector(
            "textarea.trumbowyg-editor"
          );
          const translation = textarea
            ? $(textarea).trumbowyg("html").toLowerCase()
            : "";
          row.style.display =
            original.includes(filter) || translation.includes(filter)
              ? ""
              : "none";
        });
      }

      function copyToTranslation(idx) {
        const rows = document.querySelectorAll("#xlfTable tbody tr");
        const row = rows[idx];
        if (!row) return;

        const sourceTextarea = row.cells[1].querySelector("textarea");
        const targetTextarea = row.cells[3].querySelector("textarea");
        if (!sourceTextarea || !targetTextarea) return;

        if (targetTextarea.classList.contains("trumbowyg-editor")) {
          const sourceContent = $(sourceTextarea).trumbowyg("html");
          $(targetTextarea).trumbowyg("html", sourceContent);
        } else {
          targetTextarea.value = sourceTextarea.value;
        }

        hasUnsavedChanges = true;
        updateUnsavedIndicator();
      }

      function saveTranslations() {
        const rows = document.querySelectorAll("#xlfTable tbody tr");
        const pairs = Array.from(rows).map((row, idx) => {
          const textarea = row.cells[3].querySelector("textarea");
          let value = "";
          if (textarea.classList.contains("trumbowyg-editor")) {
            value = $(textarea).trumbowyg("html");
            value = value.replace(/<p><br><\/p>/g, "");
            value = value.replace(/<p><\/p>/g, "");
            value = value.replace(/<br>/g, "");
            value = value.trim();
          } else {
            value = textarea.value;
          }
          return {
            source: row.cells[1].innerText,
            target: value,
          };
        });
        vscode.postMessage({ command: "saveTranslations", pairs });

        pairs.forEach((pair, idx) => {
          originalValues.set(idx, pair.target);
        });
        hasUnsavedChanges = false;
        updateUnsavedIndicator();
      }

      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          saveTranslations();
        }
      });

      let startX, startWidth, resizerCol, nextCol, startNextWidth;
      document.querySelectorAll(".resizer").forEach((resizer) => {
        resizer.addEventListener("mousedown", function (e) {
          const colId = resizer.dataset.col;

          forceButtonColumnWidth();

          if (colId === "col-original" || colId === "col-copy") {
            resizerCol = document.getElementById("col-original");
            nextCol = document.getElementById("col-translation");
          } else {
            resizerCol = document.getElementById(colId);
            const cols = Array.from(document.querySelectorAll("colgroup col"));
            const currentIndex = cols.indexOf(resizerCol);
            nextCol = cols[currentIndex + 1];
          }

          startX = e.pageX;
          startWidth = parseInt(
            document.defaultView.getComputedStyle(resizerCol).width,
            10
          );
          startNextWidth = parseInt(
            document.defaultView.getComputedStyle(nextCol).width,
            10
          );
          document.documentElement.addEventListener("mousemove", onMouseMove);
          document.documentElement.addEventListener("mouseup", onMouseUp);
          e.preventDefault();
        });
      });
      function onMouseMove(e) {
        if (!resizerCol || !nextCol) return;
        const diff = e.pageX - startX;
        const table = document.getElementById("xlfTable");
        const minWidth = table.offsetWidth * 0.25;

        let newWidth = startWidth + diff;
        let newNextWidth = startNextWidth - diff;

        if (newWidth < minWidth) {
          newWidth = minWidth;
          newNextWidth = startWidth + startNextWidth - minWidth;
        }
        if (newNextWidth < minWidth) {
          newNextWidth = minWidth;
          newWidth = startWidth + startNextWidth - minWidth;
        }

        resizerCol.style.width = newWidth + "px";
        nextCol.style.width = newNextWidth + "px";

        forceButtonColumnWidth(true);
      }
      function onMouseUp() {
        document.documentElement.removeEventListener("mousemove", onMouseMove);
        document.documentElement.removeEventListener("mouseup", onMouseUp);
        resizerCol = null;
        nextCol = null;
      }
    </script>
  </body>
</html>
